---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
source("tianfengRwrappers.R")
ds2 <- readRDS("ds2.rds")
selected_features <- read.csv("./datatable/ds2_features.csv", stringsAsFactors = F)
selected_features <- selected_features$Feature
Idents(ds2) <- ds2$seurat_clusters
ggobj <- multi_featureplot(selected_features[1:9], ds2, labels = NULL)
ggsave("ds2_features.png", device = png, height = 8, width = 8, plot = ggobj)
```
## 病变亚群的识别
### LUM
```{r}
sep = 0.3
surfaceplot2("LUM",ds2,x_seq = seq(-2,13, sep), y_seq = seq(2,17,sep))
```

```{r}
surfaceplot2("ACTA2",ds2,x_seq = seq(-2,13, sep), y_seq = seq(2,17,sep))
```
### LUM
```{r}
sep = 0.3
surfaceplot2("BGN",ds2,x_seq = seq(-2,13, sep), y_seq = seq(2,17,sep))
```


```{r}
surfaceplot2("FB_score1",ds2,x_seq = seq(-2,13, sep), y_seq = seq(2,17,sep),z_height = 2)
```

```{r}
surfaceplot2("SMC_score1",ds2,x_seq = seq(-2,13, sep), y_seq = seq(2,17,sep),z_height = 2)
```


```{r}
dd <- umapplot(ds2,label = F)+scale_y_continuous(limits = c(2,17), breaks = NULL) +
        scale_x_continuous(limits = c(-2,13), breaks = NULL)+ 
  guides(colour = guide_legend(override.aes = list(size = 5))) +
        theme(axis.line = element_blank())
ggsave("dd.png",device = png,height = 4,width = 6,plot= dd, bg = "transparent")

```

#  addmodulescore
```{r fig.height=3, fig.width=3}
geneset <- read.table("SMC")
ds2 <- AddModuleScore(ds2,features = geneset, name = 'SMC_score')
ds2_AC <- AddModuleScore(ds2_AC,features = geneset, name = 'SMC_score')
ds2_PA <- AddModuleScore(ds2_PA,features = geneset, name = 'SMC_score')
f("SMC_score1",label = F, ds2_AC) + scale_colour_gradient(low="#1E90FF", high="#ff2121")
f("SMC_score1",label = F, ds2_PA) + scale_colour_gradient(low="#1E90FF", high="#ff2121")
# dataset1 <- AddModuleScore_UCell(dataset1,features = geneset, name = 'fibromyo_score')
# f("V1fibromyo_score", dataset1)

geneset <- read.table("FB")
ds2 <- AddModuleScore(ds2,features = geneset, name = 'FB_score')
ds2_AC <- AddModuleScore(ds2_AC,features = geneset, name = 'FB_score')
ds2_PA <- AddModuleScore(ds2_PA,features = geneset, name = 'FB_score')
f("FB_score1", label = F, ds2_AC) +scale_colour_gradient(low="#1E90FF", high="#ff2121")
f("FB_score1", label = F, ds2_PA) +scale_colour_gradient(low="#1E90FF", high="#ff2121")
```

```{r}
df <- FetchData(ds2_AC,vars = c("FB_score1","SMC_score1","BGN","LUM","UMAP_1","UMAP_2"))
# df <- arrange(df,FB_score1,by_group = F)
data <- cbind(df,index = 1:nrow(df),cluster = Idents(ds2_AC))

ggplot(data,aes(x=SMC_score1)) + geom_point(aes(y = BGN, color = cluster),alpha = 1) + geom_smooth(aes(y = BGN), color = "red") + theme_classic() + mytheme +scale_y_continuous(limits = c(1,5)) + scale_color_manual(values = colors_list)

ggplot(data,aes(x=FB_score1)) + geom_point(aes(y = LUM, color = cluster),alpha = 1) + geom_smooth(aes(y = BGN), color = "green") + theme_classic() + mytheme +scale_y_continuous(limits = c(1,5)) + scale_color_manual(values = colors_list)



df <- FetchData(ds2_PA,vars = c("FB_score1","SMC_score1","BGN","LUM","UMAP_1","UMAP_2"))
# df <- arrange(df,FB_score1,by_group = F)
data <- cbind(df,index = 1:nrow(df),cluster = Idents(ds2_PA))

ggplot(data,aes(x=SMC_score1)) + geom_point(aes(y = BGN, color = cluster),alpha = 1) + geom_smooth(aes(y = BGN), color = "red") + theme_classic() + mytheme +scale_y_continuous(limits = c(1,5)) + scale_color_manual(values = colors_list)

ggplot(data,aes(x=FB_score1)) + geom_point(aes(y = LUM, color = cluster),alpha = 1) + geom_smooth(aes(y = BGN), color = "green") + theme_classic() + mytheme +scale_y_continuous(limits = c(1,5)) + scale_color_manual(values = colors_list)




ggplot(data,aes(x=FB_score1)) + geom_point(aes(y = BGN),color = "#e2b398",alpha = 1) + geom_smooth(aes(y = BGN), color = "red") + geom_point(aes(y=LUM),color = "#d1eba8",alpha = 1) + geom_smooth(aes(y = LUM), color = "green") + theme_classic() + mytheme +scale_y_continuous(limits = c(1,5))

```

# GSVA
```{r}
GSVAres <- readRDS("GSVAres.rds")
es <- data.frame(t(GSVAres),stringsAsFactors=F)  #可视化相关通路的在umap上聚集情况
ds2 <- AddMetaData(ds2, es)
f("CUI_TCF21_TARGETS_UP", label = F, ds2) +scale_colour_gradient(low="#1E90FF", high="#ff2121")
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
