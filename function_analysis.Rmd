---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

# AC和PA的SMC进一步分析
```{r}
source("tianfengRwrappers.R")
library(org.Hs.eg.db)
library(msigdbr)
library(GSVA)
library(fgsea)
library(UCell)
ds2 <- readRDS("ds2.rds")
ds0 <- readRDS("ds0.rds")
ds1 <- readRDS("ds1.rds")
```

## 分离AC和PA的SMC亚群
```{r}
select.cells <- CellSelector(plot = DimPlot(ds2, reduction = "umap")) #去除边角的离群细胞
ds2 <- subset(ds2, cell = select.cells)
# saveRDS(ds2,"ds2.rds")
umapplot(ds2,split.by = "conditions")
ds2 <- ds2 %>% FindNeighbors(dims = 1:20) %>% FindClusters(resolution = 0.15)
umapplot(ds2, group.by = "seurat_clusters",split.by = "conditions")
Idents(ds2) <- ds2$conditions
ds2_AC <- subset(ds2, idents = "AC")
ds2_PA <- subset(ds2, idents = "PA")
ds2_AC <- ds2_AC %>% FindNeighbors(dims = 1:20) %>% FindClusters(resolution = 0.1)
ds2_PA <- ds2_PA %>% FindNeighbors(dims = 1:20) %>% FindClusters(resolution = 0.1)

umapplot(ds2_AC) + scale_y_continuous(limits = c(-5,15),breaks = NULL) +
        scale_x_continuous(limits = c(-5,15),breaks = NULL)
umapplot(ds2_PA)+ scale_y_continuous(limits = c(-5,15),breaks = NULL) +
        scale_x_continuous(limits = c(-5,15),breaks = NULL)
```
## find markers
```{r}
ds2_AC_markers <- FindAllMarkers(ds2_AC, logfc.threshold = 0.5, min.diff.pct = 0.2, only.pos = F)
ds2_AC_markers_pos <- ds2_AC_markers[ds2_AC_markers$avg_logFC>0, ]
ds2_AC_markers_neg <- ds2_AC_markers[ds2_AC_markers$avg_logFC<0, ]
```
```{r}
f("DLX6", ds0, split.by='conditions')
f("DLX6-AS1", ds1)
table(Idents(ds2_AC))
```


## GO and KEGG

```{r,fig.width=8,fig.height=4}
##up-regulated genes
gene_list <- ds2_AC_markers_pos[ds2_AC_markers_pos$cluster == 2,]$gene

up_enrich.go <- enrichGO(
    gene = gene_list, # 基因列表文件中的基因名称
    OrgDb = org.Hs.eg.db, keyType = "SYMBOL",
    ont = "ALL", # 可选 BP、MF、CC，也可以指定 ALL 同时计算 3 者
    pAdjustMethod = "fdr", pvalueCutoff = 0.05, qvalueCutoff = 0.2)

dotplot(up_enrich.go, showCategory = 10)
cnetplot(up_enrich.go, showCategory = 10)
emapplot(up_enrich.go, showCategory = 10)

##down-regulated genes
gene_list <- ds2_AC_markers_neg[ds2_AC_markers_neg$cluster == 2,]$gene
down_enrich.go <- enrichGO(
    gene = gene_list, # 基因列表文件中的基因名称
    OrgDb = org.Hs.eg.db, keyType = "SYMBOL",
    ont = "ALL", # 可选 BP、MF、CC，也可以指定 ALL 同时计算 3 者
    pAdjustMethod = "fdr", pvalueCutoff = 0.05, qvalueCutoff = 0.2)

dotplot(down_enrich.go, showCategory = 10)
cnetplot(down_enrich.go, showCategory = 10)
emapplot(down_enrich.go, showCategory = 10)

```


## GSVA
```{r}
exprmat <- get_data_table(ds2_AC, highvar = T,type = "data")
clusterinfo <- ds2_AC@meta.data[,c("orig.ident","Classification1")]
mbd <- msigdbr(species = "Homo sapiens", category = "C7") # C7 免疫
msigdbr_list <- split(x = mbd$gene_symbol, f = mbd$gs_name)

immo_res <- gsva(exprmat, msigdbr_list, kcdf="Gaussian",method = "gsva", parallel.sz = 6) #gsva 在server上运行
pheatmap(immo_res, show_rownames=1, show_colnames=0, 
         annotation_col=clusterinfo,fontsize_row=5, wiidth=8, height=6)#绘制热图
```


```{r}
es <- data.frame(t(immo_res),stringsAsFactors=F)  #添加到单细胞矩阵中，可视化相关通路的在umap上聚集情况，可理解为一个通路即一个基因
dataset1 <- AddclusterinfoData(pbmc, es)
FeaturePlot(dataset1, features = "KEGG_PRIMARY_BILE_ACID_BIOSYNTHESIS", reduction = 'umap')
multi_featureplot()

```

#GSEA
```{r}
library(clusterProfiler)
markers <- FindMarkers(ds2_AC, ident.1 = 3, logfc.threshold = 0.1, min.diff.pct = 0.1)
DEGs <- markers$avg_logFC
names(DEGs) = rownames(markers)
DEGs <- sort(DEGs,decreasing = T)
head(DEGs)

# GO_db <- msigdbr(species = "Homo sapiens",category = "C2") %>% 
#   dplyr::select(gs_exact_source,gene_symbol) #C5 GO  C7 免疫

mdb_c2 <- msigdbr(species = "Homo sapiens", category = "C2")
mdb_kegg <-  mdb_c2 [grep("^KEGG", mdb_c2 $gs_name),]
GO_db<-mdb_kegg %>% dplyr::select(gs_name, gene_symbol)

GSEA_res <- clusterProfiler::GSEA(DEGs, TERM2GENE = GO_db,pvalueCutoff = 0.5)

dotplot(GSEA_res,split=".sign")+facet_grid(~.sign)

enrichplot::gseaplot2(GSEA_res, geneSetID = 1, title = GSEA_res$Description[1])

for(i in seq_along(GSEA_res@result$ID)){
  gseaplot2(GSEA_res, geneSetID = i, title = GSEA_res@result$ID[i])
}

```


#  addmodulescore
```{r}
geneset <- read.table("fibromyo")
dataset1 <- AddModuleScore(dataset1,features = geneset, name = 'fibromyo_score')
f("fibromyo_score1", dataset1, min.cutoff = 0)
dataset1 <- AddModuleScore_UCell(dataset1,features = geneset, name = 'fibromyo_score')
f("V1fibromyo_score", dataset1)
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
