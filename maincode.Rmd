---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
source("./tianfengRwrappers.R")
# plan("multiprocess",workers = 8)
```

#冠状动脉

```{r}
human_coronary_countmatrix <- read.csv("GSE131778_human_coronary_scRNAseq.txt", sep = "\t")
func <- function(s) {
  paste0(strsplit(s, ".", fixed = T)[[1]][2], "_", strsplit(s, ".", fixed = T)[[1]][1])
}
colnames(human_coronary_countmatrix) <- lapply(colnames(human_coronary_countmatrix), func) # 拆分样本
```

```{r}
human_coronary <- CreateSeuratObject(counts = human_coronary_countmatrix, 
                                     project = "human_coronary", min.cells = 10, min.features = 300) %>% 
    PercentageFeatureSet(pattern = "^MT-", col.name = "percent.mt") %>%
    subset(subset = nFeature_RNA > 600 & nFeature_RNA < 6000 & nCount_RNA > 1000 &  nCount_RNA < 30000) %>%
    SCTransform(vars.to.regress = "percent.mt", verbose = F) %>% 
    RunPCA() %>% FindNeighbors(dims = 1:20) %>% 
    RunUMAP(dims = 1:20) %>% 
    FindClusters(resolution = 0.1)
rm(human_coronary_countmatrix)
f("PLVAP",human_coronary)
```


# 颈动脉斑块 CA dataset1
```{r}
# 批量读取计数矩阵
# 需要把行名的gene删掉，用vscode修改
count_mats <- list.files("./CA_GSE155512")
count_mats <- count_mats[count_mats != "sampleinfo.txt"]
allList <- lapply(count_mats, function(folder) {
  CreateSeuratObject(
    counts = read.csv(paste0("./CA_GSE155512/", folder), sep = "\t"),
    project = folder, min.cells = 10, min.features = 300
  )
})
# 合并seurat对象
CA_dataset1 <- merge(allList[[1]],
  y = allList[-1], add.cell.ids = count_mats,
  project = "CA_dataset1"
)
rm(allList)

CA_dataset1 <- PercentageFeatureSet(CA_dataset1, pattern = "^MT-", col.name = "percent.mt") %>%
    subset(subset = nFeature_RNA > 600 & nFeature_RNA < 6000 & nCount_RNA > 1000 &  nCount_RNA < 30000) %>%
    SCTransform(vars.to.regress = "percent.mt", verbose = F) %>% 
    RunPCA() %>% FindNeighbors(dims = 1:20) %>% 
    RunUMAP(dims = 1:20) %>% 
    FindClusters(resolution = 0.1)

```


# 颈动脉斑块 CA dataset2
```{r}
CA_dataset2 <- CreateSeuratObject(Read10X("./CA_GSE159677/"), names.field = 2, names.delim = "-",
                                     project = "CA_dataset2", min.cells = 10, min.features = 300) %>% 
    PercentageFeatureSet(pattern = "^MT-", col.name = "percent.mt") %>%
    subset(subset = nFeature_RNA > 600 & nFeature_RNA < 6000 & nCount_RNA > 1000 &  nCount_RNA < 30000) %>%
    SCTransform(vars.to.regress = "percent.mt", verbose = F) %>% 
    RunPCA() %>% FindNeighbors(dims = 1:20) %>% 
    RunUMAP(dims = 1:20) %>% 
    FindClusters(resolution = 0.1)
```


# 添加metadata samples存储完整信息，conditions按区域分，groups按病例分
```{r}
Idents(human_coronary) <- human_coronary$orig.ident
Idents(human_coronary) <- c("1","1","2","2","3","3","4","4")
human_coronary$samples <- Idents(human_coronary)
Idents(human_coronary) <- human_coronary$seurat_clusters

Idents(CA_dataset2) <- CA_dataset2$orig.ident
CA_dataset2 <- RenameIdents(CA_dataset2,'1' = 'AC_1','2' = 'PA_1','3' = 'AC_2','4' = 'PA_2','5' = 'AC_3','6' = 'PA_3')
UMAPPlot(CA_dataset2)

CA_dataset2$sample <- Idents(CA_dataset2)
CA_dataset2 <- RenameIdents(CA_dataset2,'AC_1' = 'AC','PA_1' = 'PA','AC_2'= 'AC','PA_2'= 'PA','AC_3'= 'AC','PA_3'= 'PA')
CA_dataset2$conditions <- Idents(CA_dataset2)
Idents(CA_dataset2) <- CA_dataset2$orig.ident
CA_dataset2 <- RenameIdents(CA_dataset2, '1' = 'sp_1','2' = 'sp_1','3' = 'sp_2','4' = 'sp_2','5' = 'sp_3','6' = 'sp_3')
CA_dataset2$groups <- Idents(CA_dataset2)
Idents(CA_dataset2) <- CA_dataset2$seurat_clusters
```

# 保存结果
```{r}
saveRDS(human_coronary,"human_coronary.rds")
saveRDS(CA_dataset1,"CA_dataset1.rds")
saveRDS(CA_dataset2,"CA_dataset2.rds") #已经经过分组处理了
```

----
# 读取结果
```{r}
human_coronary <- readRDS("human_coronary.rds")
CA_dataset1 <- readRDS("CA_dataset1.rds")
CA_dataset2 <- readRDS("CA_dataset2.rds") #已经经过分组处理了
```

## 修改分群
```{r}
umapplot(CA_dataset2, split.by = "sample")
umapplot(CA_dataset2,group.by = "groups", split.by = "conditions")
multi_featureplot(c("HEY1","GJA5","SEMA3G","CXCL12","SOX17","CDH5","PECAM1"),CA_dataset2)
multi_featureplot(c("ACKR1","PLVAP","ITGA6","PECAM1"),CA_dataset2)
```
```{r}
# table(CA_dataset2$sample)

# 关注cluster 3-6 EC
# cluster 7 基质细胞

multi_featureplot(c("LYZ","PTPRC","CD69","EPCAM","CDH1","PDGFRB","COL1A2","PECAM1","CLDN5"),CA_dataset2)

Dotplot(c("LUM","MMP2","MGP","DCN","MYH11","ACTA2","CNN1","TAGLN"),CA_dataset2) #cluster 7 细胞可以被认为是modulated SMCs
CA_dataset2 <- AddModuleScore(CA_dataset2,list(c("LUM","MMP2","MGP","DCN")))
CA_dataset2 <- AddModuleScore(CA_dataset2,list(c("MYH11","ACTA2","CNN1","TAGLN")))
multi_featureplot(c("Cluster1","LUM","ACTA2","TAGLN"),CA_dataset2)
multi_featureplot(c("MMP2","GJA4","PECAM1","ACKR1"), CA_dataset2)
multi_featureplot(c("MMP2","GJA4","PECAM1","ACKR1"), human_coronary)

```
# 基质细胞分类
```{r}
multi_featureplot(c("LYZ","PTPRC","CD69","PDGFRB","COL1A2","PECAM1","CLDN5"), CA_dataset2)
# multi_featureplot(c("ACTA2","FN1"), CA_dataset2)
umapplot(CA_dataset2)
lym_ds2 <- subset(CA_dataset2, idents = c('0','4','9'))  #human_cor 选择0 3 4  CA_dataset1 选择0，4作为基质细胞 CA_dataset2 选择7和2作为基质细胞 myeloid CA_dataset2 1
#CA_dataset2 选择7和2作为基质细胞
umapplot(lym_ds2,split.by = "sample")# 淋巴
saveRDS(lym_ds2,"lym_ds2.rds")

# saveRDS(ds0,"ds0.rds")
# 
# saveRDS(ds1,"ds1.rds")

```



# ECs亚群分析 整合
## 整合算法可能出现负值，运行SCENIC时舍弃了这些异常值
```{r}
# 提取内皮细胞亚群
ECs_list <- list(subset(CA_dataset1, idents = "Endothelial"), subset(human_coronary, idents = "Endothelial"))

ECs_list <- lapply(X = ECs_list, FUN = function(x) {
  x <- NormalizeData(x)
  x <- FindVariableFeatures(x, selection.method = "vst", nfeatures = 2000)
})
# 需要分析的差异基因
int_features <- SelectIntegrationFeatures(object.list = ECs_list)
# 选择合并的anchor特征
int_anchors <- FindIntegrationAnchors(object.list = ECs_list, anchor.features = int_features)

# 根据anchor合并
ECs_combined <- IntegrateData(anchorset = int_anchors)

DefaultAssay(ECs_combined) <- "integrated"
rm("ECs_list", "int_features", "int_anchors")
```


```{r}
multi_featureplot(c("TNFRSF11B","ACTA2","CNN1","LUM"),human_coronary)
multi_featureplot(c("TNFRSF11B","ACTA2","CNN1","LUM"),CA_dataset1)
multi_featureplot(c("TNFRSF11B","ACTA2","CNN1","LUM"),CA_dataset2)
```

```{r}
genes <- c("LGALS3","CD68","KLF4","CLDN5","VWF","ACTA2")
multi_featureplot(genes,CA_dataset2)
Dotplot(genes,CA_dataset2) # 2>5
multi_featureplot(genes,human_coronary)
Dotplot(genes,human_coronary)
```
# cellchat
```{r}

```


# 差异基因
```{r}
umapplot(ds2,split.by = "conditions")
ds2 <- ds2 %>% FindNeighbors(dims = 1:20) %>% FindClusters(resolution = 0.1)
umapplot(ds2, group.by = "seurat_clusters",split.by = "conditions")
Idents(ds2) <- ds2$conditions
ds2_AC <- subset(ds2, idents = "AC")
ds2_PA <- subset(ds2, idents = "PA")
ds2_AC <- ds2_AC %>% FindNeighbors(dims = 1:20) %>% FindClusters(resolution = 0.1)
ds2_PA <- ds2_PA %>% FindNeighbors(dims = 1:20) %>% FindClusters(resolution = 0.1)

umapplot(ds2_AC) + scale_y_continuous(limits = c(-5,15),breaks = NULL) +
        scale_x_continuous(limits = c(-5,15),breaks = NULL)
umapplot(ds2_PA)+ scale_y_continuous(limits = c(-5,15),breaks = NULL) +
        scale_x_continuous(limits = c(-5,15),breaks = NULL)

ds2_markers <- FindAllMarkers(ds2, logfc.threshold = 0.5, min.diff.pct = 0.3)

multi_featureplot(c("DCN","VCAM1","LUM","CNN1","ACTA2","GJA4","OMD","	
FBLN1","CXCL14","C3"),ds2)

Dotplot(c("DCN","VCAM1","LUM","CNN1","ACTA2","GJA4","OMD","FBLN1","CXCL14","C3"),ds2)
```



# 功能分析
```{r}
library(org.Hs.eg.db)
GO_dotplot()
```

